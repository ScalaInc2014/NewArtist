{"filter":false,"title":"strategy.js","tooltip":"/Authentication/Facebook/strategy.js","ace":{"folds":[],"scrolltop":491,"scrollleft":0,"selection":{"start":{"row":43,"column":44},"end":{"row":43,"column":44},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"hash":"d01c3bb5c001e827806de28b41f99c421633028d","undoManager":{"mark":8,"position":8,"stack":[[{"start":{"row":0,"column":0},"end":{"row":81,"column":29},"action":"insert","lines":["var mongoose = require('mongoose');","var PassportStrategy = require('passport-facebook').Strategy;","var strategyProperties = require('./config');","var models = require(\"../../Models\");","","","var getUserConfiguration = function(profile, accessToken, userType) {","    ","    var user = {};","    var currentDate = new Date();","    var Id = mongoose.Types.ObjectId();","    var profilePicturePath = 'https://graph.facebook.com/' + profile.id + '/picture' + '?width=200&height=200' + '&access_token=' + accessToken;   ","    user.model = models[userType];","   ","    if(userType === 'fan') {","        ","        user.dataStructure = {","            fanId: Id,","            info:{","                name: profile.displayName,","                password: '',","                email: profile._json.email,","                birthday: profile._json.birthday,","                gender: profile._json.gender,","                avatarPath: profilePicturePath,","                location: profile._json.location.name","            },","            registerDate: currentDate,","            registerMode: 'facebook',","            mailConfirmation: true,","            token: accessToken,","        };","    }","  ","    return user;","};","","var getStrategy = function(userType){","","    var strategy = new PassportStrategy(strategyProperties ,","        ","        function(accessToken, refreshToken, profile, done){","","            var userModel = models[userType]; ","            var email = profile._json.email;","            userModel.socialSignin(email, 'facebook')","                ","                .then(function(result){","","                    if(result.user)","                        return done(null,result.user);","                    else{","","                        var user = getUserConfiguration(profile, accessToken, 'fan');","                        user.model.registerPromise(user.dataStructure)","                    ","                        .then(function(result){","             ","                            if(result.user)                   ","                                return done(null, user.dataStructure);                ","                            else ","                                return done(null, false, { message: result.informationMessage });                             ","                        })","                        ","                        .then(null,function(err){","                            ","                            return done(err);","                            ","                        });                         ","                    }","                })","                ","                .then(null,function(err){","                    ","                    return done(err);","                });                      ","        }","    );","    return strategy;","};","","module.exports = getStrategy;"],"id":1}],[{"start":{"row":50,"column":41},"end":{"row":50,"column":42},"action":"insert","lines":[" "],"id":2,"ignore":true}],[{"start":{"row":53,"column":78},"end":{"row":53,"column":83},"action":"remove","lines":["'fan'"],"id":3,"ignore":true},{"start":{"row":53,"column":78},"end":{"row":53,"column":81},"action":"insert","lines":["use"]}],[{"start":{"row":53,"column":81},"end":{"row":53,"column":82},"action":"insert","lines":["r"],"id":4,"ignore":true}],[{"start":{"row":53,"column":78},"end":{"row":53,"column":82},"action":"remove","lines":["user"],"id":5,"ignore":true},{"start":{"row":53,"column":78},"end":{"row":53,"column":86},"action":"insert","lines":["userType"]}],[{"start":{"row":11,"column":147},"end":{"row":12,"column":34},"action":"remove","lines":["","    user.model = models[userType];"],"id":6,"ignore":true}],[{"start":{"row":11,"column":144},"end":{"row":11,"column":147},"action":"remove","lines":["   "],"id":7,"ignore":true}],[{"start":{"row":53,"column":28},"end":{"row":53,"column":30},"action":"remove","lines":[".m"],"id":8,"ignore":true}],[{"start":{"row":53,"column":28},"end":{"row":53,"column":29},"action":"insert","lines":["M"],"id":9,"ignore":true}]]},"timestamp":1432329563000}